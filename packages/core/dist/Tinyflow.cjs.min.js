"use strict";var t=["name","id","steps"],e=["id","workflowId","name","data","next"];function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(t)}function r(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,o,i,a,u=[],c=!0,s=!1;try{if(i=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=i.call(n)).done)&&(u.push(r.value),u.length!==e);c=!0);}catch(t){s=!0,o=t}finally{try{if(!c&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(s)throw o}}return u}}(t,e)||d(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t,e){if(null==t)return{};var n,r,o=function(t,e){if(null==t)return{};var n,r,o={},i=Object.keys(t);for(r=0;r<i.length;r++)n=i[r],e.indexOf(n)>=0||(o[n]=t[n]);return o}(t,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);for(r=0;r<i.length;r++)n=i[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(o[n]=t[n])}return o}function i(t,e,r){return e=l(e),function(t,e){if(e&&("object"===n(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,c()?Reflect.construct(e,r||[],l(t).constructor):e.apply(t,r))}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&s(t,e)}function u(t){var e="function"==typeof Map?new Map:void 0;return u=function(t){if(null===t||!function(t){try{return-1!==Function.toString.call(t).indexOf("[native code]")}catch(e){return"function"==typeof t}}(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return function(t,e,n){if(c())return Reflect.construct.apply(null,arguments);var r=[null];r.push.apply(r,e);var o=new(t.bind.apply(t,r));return n&&s(o,n.prototype),o}(t,arguments,l(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),s(n,t)},u(t)}function c(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(c=function(){return!!t})()}function s(t,e){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},s(t,e)}function l(t){return l=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},l(t)}function f(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function p(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,O(r.key),r)}}function h(t,e,n){return e&&p(t.prototype,e),n&&p(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function y(t){return function(t){if(Array.isArray(t))return m(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||d(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(t,e){if(t){if("string"==typeof t)return m(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?m(t,e):void 0}}function m(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function b(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function v(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?b(Object(n),!0).forEach((function(e){w(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):b(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function w(t,e,n){return(e=O(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function O(t){var e=function(t,e){if("object"!=n(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var o=r.call(t,e||"default");if("object"!=n(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==n(e)?e:String(e)}var g={},j={extensions:new Map,listeners:new WeakMap,id:function(){return Math.random().toString(16).substring(2,16)},history:function(t){return{name:t.name,data:v({},t.data),at:new Date}}},k=j.extensions,S=j.listeners;S.by=function(t,e){return S.has(t)||S.set(t,new Map),S.get(t).get(e)||[]},g.extend=function(t){return t(j,{Tinyflow:g,TinyflowError:E,Workflow:T,Step:A,Emitter:x})},g.use=function(t,e){(null===e?k.delete:k.set).call(k,t,e)};var P=function(t){return setTimeout(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0)},x=function(){function t(){f(this,t)}return h(t,[{key:"on",value:function(t,e){var n=S.by(this,t);n.push(e),S.get(this).set(t,n)}},{key:"once",value:function(t,e){e.once=!0,this.on(t,e)}},{key:"off",value:function(t,e){if(t){var n=S.by(this,t);e||(n.length=0);var r=n.length>0&&n.findIndex((function(t){return t===e}));if(!(r>-1))throw new E("No listener found by function for event ".concat(t),{id:this.id,name:this.name});n.splice(r,1),S.get(this).set(t,n)}else S.get(this).clear()}},{key:"emit",value:function(t,e){for(var n=this,r=S.by(this,t).reverse(),o=function(){var t=r[i];P((function(){var r,o;(r=t,o=[e],new Promise((function(t,e){try{t(r.apply(void 0,y(o)))}catch(t){e(t)}}))).catch((function(t){return n.emit("error",{error:t,source:n})}))})),t.once&&r.splice(i,1)},i=r.length-1;i>=0;i--)o();S.get(this).set(t,r)}}]),t}(),E=function(t){function e(t,n){var r;return f(this,e),(r=i(this,e,[t])).name="TinyflowError",r.details=n,r}return a(e,u(Error)),h(e)}(),I=function(t){var e=t.workflow,n=t.step,r=t.onSuccess,o=t.onError,i=e||n;Promise.all(Object.keys(i.custom).filter((function(t){return k.has(t)})).map((function(t){return k.get(t)(i.custom[t],{workflow:e,step:n})}))).then(r).catch(o)},T=function(e){function n(e){var a,u=e.name,c=e.id,s=e.steps,l=void 0===s?{}:s,p=o(e,t);f(this,n),(a=i(this,n)).name=u,a.id=c||j.id(),a.data=null,a.state="pending",a.custom={},a.history=[];var h={};if(Object.entries(p).forEach((function(t){var e=r(t,2),n=e[0],o=e[1],i=r(Array.isArray(o)?o:[o,"all"],2),u=i[0],c=i[1];["all","workflow"].includes(c)&&(a.custom[n]=u),["all","steps"].includes(c)&&(h[n]=u)})),a.steps=Object.entries(l).map((function(t,e,n){var o=r(t,2),i=o[0],a=o[1];return v(v({next:e<n.length-1?e+1:null,name:i},h),a)})),0===a.steps.length)throw new E("Workflow steps must have at least one entry, got 0",{name:u,id:c});return a.current=null,a}return a(n,x),h(n,[{key:"start",value:function(){var t=this,e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).autoStep;if("active"===this.state)throw new E("Cannot start active workflow",{name:this.name,id:this.id});this.data=Object.create(null);var n=this;I({workflow:n,onSuccess:function(){t.state="active",t.emit("started",t),!1!==e&&t.step(0)},onError:function(e){return t.emit("error",{error:e,workflow:n})}})}},{key:"step",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=n.stepId,o=n.autoOnEnd;if("active"!==this.state)throw new E('Can only step in an active state, got "'.concat(this.state,'"'),{indexOrName:t,name:this.name,id:this.id});var i="number"==typeof t?this.steps[t]:this.steps.find((function(e){return e.name===t}));if(!i)throw new E("Expected step definition, got ".concat(i),{indexOrName:t,name:this.name,id:this.id});var a=r||j.id(),u=this.id,c=new A(v({id:a,workflowId:u},i)),s=this,l=function(t){return t&&(t.off(),e.history.push(j.history(t,s))),!0};!1!==o&&c.once("end",(function(t){s.data[t.name]=v({},t.data);var e=t.next;return null!==e&&e<=s.steps.length-1?P((function(){return s.step(e)})):l(t)&&s.complete()})),c.start(),l(this.current),this.current=c,this.emit("step",this)}},{key:"complete",value:function(){this.current&&this.current.off(),this.current=null,this.state="complete",this.emit("end",this)}},{key:"cancel",value:function(){this.current&&this.current.off(),this.data=null,this.current=null,this.state="cancelled",this.emit("end",this)}}]),n}(),A=function(t){function n(t){var r,a=t.id,u=t.workflowId,c=t.name,s=t.data,l=void 0===s?null:s,p=t.next,h=o(t,e);return f(this,n),(r=i(this,n)).id=a||j.id(),r.workflowId=u,r.name=c,r.next=p,r.custom=h,r.state="pending",r.data=l,r}return a(n,x),h(n,[{key:"start",value:function(){var t=this;if("active"===this.state)throw new E("Cannot start a step in active state",{name:this.name,id:this.id,wf:this.workflowId});this.data=this.data||Object.create(null);var e=this;I({step:e,onSuccess:function(){t.state="active",t.emit("started",t)},onError:function(n){return t.emit("error",{error:n,step:e})}})}},{key:"update",value:function(t){if("active"!==this.state)throw new E('Can only update in an active state, got "'.concat(this.state,'"'),{name:this.name,id:this.id,wf:this.workflowId});this.data=Object.create(null),Object.assign(this.data,t),this.emit("update",this)}},{key:"complete",value:function(){this.state="complete",this.emit("end",this)}},{key:"cancel",value:function(){this.state="cancelled",this.data=null,this.emit("end",this)}}]),n}();exports.Step=A,exports.Tinyflow=g,exports.Workflow=T;//# sourceMappingURL=Tinyflow.cjs.min.js.map
