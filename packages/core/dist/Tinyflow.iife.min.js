var Tinyflow=function(t){"use strict";function e(t,e,r){return e=f(e),function(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,n()?Reflect.construct(e,r||[],f(t).constructor):e.apply(t,r))}function n(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(n=function(){return!!t})()}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){s(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function o(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function u(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,o(r.key),r)}}function c(t,e,n){return e&&u(t.prototype,e),n&&u(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function s(t,e,n){return(e=o(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&h(t,e)}function f(t){return f=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},f(t)}function h(t,e){return h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},h(t,e)}function p(t){var e="function"==typeof Map?new Map:void 0;return p=function(t){if(null===t||!function(t){try{return-1!==Function.toString.call(t).indexOf("[native code]")}catch(e){return"function"==typeof t}}(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,r)}function r(){return function(t,e,r){if(n())return Reflect.construct.apply(null,arguments);var i=[null];i.push.apply(i,e);var o=new(t.bind.apply(t,i));return r&&h(o,r.prototype),o}(t,arguments,f(this).constructor)}return r.prototype=Object.create(t.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),h(r,t)},p(t)}function y(t,e){if(null==t)return{};var n,r,i=function(t,e){if(null==t)return{};var n,r,i={},o=Object.keys(t);for(r=0;r<o.length;r++)n=o[r],e.indexOf(n)>=0||(i[n]=t[n]);return i}(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(r=0;r<o.length;r++)n=o[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(i[n]=t[n])}return i}function d(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,i,o,a,u=[],c=!0,s=!1;try{if(o=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=o.call(n)).done)&&(u.push(r.value),u.length!==e);c=!0);}catch(t){s=!0,i=t}finally{try{if(!c&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(s)throw i}}return u}}(t,e)||m(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(t){return function(t){if(Array.isArray(t))return b(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||m(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(t,e){if(t){if("string"==typeof t)return b(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?b(t,e):void 0}}function b(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var w=["name","id","steps"],O=["id","workflowId","name","data","next"],g={},j={extensions:new Map,listeners:new WeakMap,id:function(){return Math.random().toString(16).substring(2,16)},history:function(t){return{name:t.name,data:i({},t.data),at:new Date}}},k=j.extensions,S=j.listeners;S.by=function(t,e){return S.has(t)||S.set(t,new Map),S.get(t).get(e)||[]},g.extend=function(t){return t(j,{Tinyflow:g,TinyflowError:x,Workflow:T,Step:A,Emitter:E})},g.use=function(t,e){(null===e?k.delete:k.set).call(k,t,e)};var P=function(t){return setTimeout(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0)},E=function(){function t(){a(this,t)}return c(t,[{key:"on",value:function(t,e){var n=S.by(this,t);n.push(e),S.get(this).set(t,n)}},{key:"once",value:function(t,e){e.once=!0,this.on(t,e)}},{key:"off",value:function(t,e){if(t){var n=S.by(this,t);e||(n.length=0);var r=n.length>0&&n.findIndex((function(t){return t===e}));if(!(r>-1))throw new x("No listener found by function for event ".concat(t),{id:this.id,name:this.name});n.splice(r,1),S.get(this).set(t,n)}else S.get(this).clear()}},{key:"emit",value:function(t,e){for(var n=this,r=S.by(this,t).reverse(),i=function(){var t=r[o];P((function(){var r,i;(r=t,i=[e],new Promise((function(t,e){try{t(r.apply(void 0,v(i)))}catch(t){e(t)}}))).catch((function(t){return n.emit("error",{error:t,source:n})}))})),t.once&&r.splice(o,1)},o=r.length-1;o>=0;o--)i();S.get(this).set(t,r)}}]),t}(),x=function(t){function n(t,r){var i;return a(this,n),(i=e(this,n,[t])).name="TinyflowError",i.details=r,i}return l(n,t),c(n)}(p(Error)),I=function(t){var e=t.workflow,n=t.step,r=t.onSuccess,i=t.onError,o=e||n;Promise.all(Object.keys(o.custom).filter((function(t){return k.has(t)})).map((function(t){return k.get(t)(o.custom[t],{workflow:e,step:n})}))).then(r).catch(i)},T=function(t){function n(t){var r,o=t.name,u=t.id,c=t.steps,s=void 0===c?{}:c,l=y(t,w);a(this,n),(r=e(this,n)).name=o,r.id=u||j.id(),r.data=null,r.state="pending",r.custom={},r.history=[];var f={};if(Object.entries(l).forEach((function(t){var e=d(t,2),n=e[0],i=e[1],o=d(Array.isArray(i)?i:[i,"all"],2),a=o[0],u=o[1];["all","workflow"].includes(u)&&(r.custom[n]=a),["all","steps"].includes(u)&&(f[n]=a)})),r.steps=Object.entries(s).map((function(t,e,n){var r=d(t,2),o=r[0],a=r[1];return i(i({next:e<n.length-1?e+1:null,name:o},f),a)})),0===r.steps.length)throw new x("Workflow steps must have at least one entry, got 0",{name:o,id:u});return r.current=null,r}return l(n,t),c(n,[{key:"start",value:function(){var t=this,e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).autoStep;if("active"===this.state)throw new x("Cannot start active workflow",{name:this.name,id:this.id});this.data=Object.create(null);var n=this;I({workflow:n,onSuccess:function(){t.state="active",t.emit("started",t),!1!==e&&t.step(0)},onError:function(e){return t.emit("error",{error:e,workflow:n})}})}},{key:"step",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=n.stepId,o=n.autoOnEnd;if("active"!==this.state)throw new x('Can only step in an active state, got "'.concat(this.state,'"'),{indexOrName:t,name:this.name,id:this.id});var a="number"==typeof t?this.steps[t]:this.steps.find((function(e){return e.name===t}));if(!a)throw new x("Expected step definition, got ".concat(a),{indexOrName:t,name:this.name,id:this.id});var u=r||j.id(),c=this.id,s=new A(i({id:u,workflowId:c},a)),l=this,f=function(t){return t&&(t.off(),e.history.push(j.history(t,l))),!0};!1!==o&&s.once("end",(function(t){l.data[t.name]=i({},t.data);var e=t.next;return null!==e&&e<=l.steps.length-1?P((function(){return l.step(e)})):f(t)&&l.complete()})),s.start(),f(this.current),this.current=s,this.emit("step",this)}},{key:"complete",value:function(){this.current&&this.current.off(),this.current=null,this.state="complete",this.emit("end",this)}},{key:"cancel",value:function(){this.current&&this.current.off(),this.data=null,this.current=null,this.state="cancelled",this.emit("end",this)}}]),n}(E),A=function(t){function n(t){var r,i=t.id,o=t.workflowId,u=t.name,c=t.data,s=void 0===c?null:c,l=t.next,f=y(t,O);return a(this,n),(r=e(this,n)).id=i||j.id(),r.workflowId=o,r.name=u,r.next=l,r.custom=f,r.state="pending",r.data=s,r}return l(n,t),c(n,[{key:"start",value:function(){var t=this;if("active"===this.state)throw new x("Cannot start a step in active state",{name:this.name,id:this.id,wf:this.workflowId});this.data=this.data||Object.create(null);var e=this;I({step:e,onSuccess:function(){t.state="active",t.emit("started",t)},onError:function(n){return t.emit("error",{error:n,step:e})}})}},{key:"update",value:function(t){if("active"!==this.state)throw new x('Can only update in an active state, got "'.concat(this.state,'"'),{name:this.name,id:this.id,wf:this.workflowId});this.data=Object.create(null),Object.assign(this.data,t),this.emit("update",this)}},{key:"complete",value:function(){this.state="complete",this.emit("end",this)}},{key:"cancel",value:function(){this.state="cancelled",this.data=null,this.emit("end",this)}}]),n}(E);return t.Step=A,t.Tinyflow=g,t.Workflow=T,t}({});//# sourceMappingURL=Tinyflow.iife.min.js.map
