{"version":3,"file":"withInstances.es5.js","sources":["../withInstances.cjs"],"sourcesContent":["/**\n * @namespace Tinyflow\n */\n\n/**\n * Tinyflow extension to manage instances (create, get, dispose).\n *\n * @function\n * @export\n * @return {function(*, {Workflow: *, Tinyflow: *, TinyflowError: *}): function(): void}\n */\nmodule.exports.withInstances = (/* config */) => (internal, { Workflow, Tinyflow, TinyflowError }) => {\n  internal.instances = new Map()\n  const { instances, listeners } = internal\n\n  /**\n   * Gets a workflow instance by its id\n   * @method\n   * @param id {string}\n   * @returns {Workflow}\n   */\n  Tinyflow.get = id => instances.get(id)\n\n  /**\n   * Returns all non-disposed workflows of any state.\n   * @method\n   * @return {Workflow[]}\n   */\n  Tinyflow.all = () => [...instances.values()]\n\n  /**\n   * Clears all instances. By default, all engines are shut down\n   * and fire the end event.\n   * @method\n   */\n  Tinyflow.clear = () => {\n    const ids = [...instances.keys()]\n    for (const instanceId of ids) {\n      const workflow = Tinyflow.get(instanceId)\n      workflow.cancel()\n      Tinyflow.dispose(instanceId)\n    }\n  }\n\n  /**\n   * Creates a new workflow instance by given workflow definitions.\n   *\n   * @param definition {object} the workflow definitions object\n   * @returns {Workflow}\n   */\n  Tinyflow.create = (definition) => {\n    const workflow = new Workflow(definition)\n    instances.set(workflow.id, workflow)\n    return workflow\n  }\n\n  /**\n   * Fully disposes a workflow, including any event listener\n   * to it, or its current step.\n   * Once complete it will finally remove the workflow from\n   * the internal instances list.\n   * @param instanceId {string}\n   * @param force {boolean=}\n   */\n  Tinyflow.dispose = (instanceId, { force = false } = {}) => {\n    const workflow = instances.get(instanceId)\n    if (!workflow) {\n      throw new TinyflowError(`Workflow does not exist by id ${instanceId}`)\n    }\n    if (!force && workflow.state === 'active') {\n      throw new TinyflowError(`Cannot dispose active workflow \"${workflow.name}\"`, { instanceId })\n    }\n    if (workflow.current) {\n      workflow.current.off()\n      workflow.current = null\n    }\n    workflow.off()\n    listeners.delete(workflow)\n    instances.delete(instanceId)\n  }\n\n  // dispose method for complete cleanup of this extension\n  return () => {\n    delete internal.instances\n    delete Tinyflow.get\n    delete Tinyflow.all\n    delete Tinyflow.clear\n    delete Tinyflow.create\n    delete Tinyflow.dispose\n  }\n}\n"],"names":["module","exports","withInstances","internal","_ref","Workflow","Tinyflow","TinyflowError","instances","Map","listeners","get","id","all","_toConsumableArray","values","clear","ids","keys","_iterator","_createForOfIteratorHelper","_step","s","n","done","instanceId","value","workflow","cancel","dispose","err","e","f","create","definition","set","_ref2","arguments","length","undefined","_ref2$force","force","concat","state","name","current","off"],"mappings":"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"}