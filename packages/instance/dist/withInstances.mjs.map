{"version":3,"file":"withInstances.mjs","sources":["../withInstances.cjs"],"sourcesContent":["/**\n * @namespace Tinyflow\n */\n\n/**\n * Tinyflow extension to manage instances (create, get, dispose).\n *\n * @function\n * @export\n * @return {function(*, {Workflow: *, Tinyflow: *, TinyflowError: *}): function(): void}\n */\nmodule.exports.withInstances = (/* config */) => (internal, { Workflow, Tinyflow, TinyflowError }) => {\n  internal.instances = new Map()\n  const { instances, listeners } = internal\n\n  /**\n   * Gets a workflow instance by its id\n   * @method\n   * @param id {string}\n   * @returns {Workflow}\n   */\n  Tinyflow.get = id => instances.get(id)\n\n  /**\n   * Returns all non-disposed workflows of any state.\n   * @method\n   * @return {Workflow[]}\n   */\n  Tinyflow.all = () => [...instances.values()]\n\n  /**\n   * Clears all instances. By default, all engines are shut down\n   * and fire the end event.\n   * @method\n   */\n  Tinyflow.clear = () => {\n    const ids = [...instances.keys()]\n    for (const instanceId of ids) {\n      const workflow = Tinyflow.get(instanceId)\n      workflow.cancel()\n      Tinyflow.dispose(instanceId)\n    }\n  }\n\n  /**\n   * Creates a new workflow instance by given workflow definitions.\n   *\n   * @param definition {object} the workflow definitions object\n   * @returns {Workflow}\n   */\n  Tinyflow.create = (definition) => {\n    const workflow = new Workflow(definition)\n    instances.set(workflow.id, workflow)\n    return workflow\n  }\n\n  /**\n   * Fully disposes a workflow, including any event listener\n   * to it, or its current step.\n   * Once complete it will finally remove the workflow from\n   * the internal instances list.\n   * @param instanceId {string}\n   * @param force {boolean=}\n   */\n  Tinyflow.dispose = (instanceId, { force = false } = {}) => {\n    const workflow = instances.get(instanceId)\n    if (!workflow) {\n      throw new TinyflowError(`Workflow does not exist by id ${instanceId}`)\n    }\n    if (!force && workflow.state === 'active') {\n      throw new TinyflowError(`Cannot dispose active workflow \"${workflow.name}\"`, { instanceId })\n    }\n    if (workflow.current) {\n      workflow.current.off()\n      workflow.current = null\n    }\n    workflow.off()\n    listeners.delete(workflow)\n    instances.delete(instanceId)\n  }\n\n  // dispose method for complete cleanup of this extension\n  return () => {\n    delete internal.instances\n    delete Tinyflow.get\n    delete Tinyflow.all\n    delete Tinyflow.clear\n    delete Tinyflow.create\n    delete Tinyflow.dispose\n  }\n}\n"],"names":[],"mappings":";;;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAA,eAAA,GAA+B,kBAAkB,CAAC,QAAQ,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,aAAa,EAAE,KAAK;AACtG,EAAE,QAAQ,CAAC,SAAS,GAAG,IAAI,GAAG,GAAE;AAChC,EAAE,MAAM,EAAE,SAAS,EAAE,SAAS,EAAE,GAAG,SAAQ;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE,QAAQ,CAAC,GAAG,GAAG,EAAE,IAAI,SAAS,CAAC,GAAG,CAAC,EAAE,EAAC;AACxC;AACA;AACA;AACA;AACA;AACA;AACA,EAAE,QAAQ,CAAC,GAAG,GAAG,MAAM,CAAC,GAAG,SAAS,CAAC,MAAM,EAAE,EAAC;AAC9C;AACA;AACA;AACA;AACA;AACA;AACA,EAAE,QAAQ,CAAC,KAAK,GAAG,MAAM;AACzB,IAAI,MAAM,GAAG,GAAG,CAAC,GAAG,SAAS,CAAC,IAAI,EAAE,EAAC;AACrC,IAAI,KAAK,MAAM,UAAU,IAAI,GAAG,EAAE;AAClC,MAAM,MAAM,QAAQ,GAAG,QAAQ,CAAC,GAAG,CAAC,UAAU,EAAC;AAC/C,MAAM,QAAQ,CAAC,MAAM,GAAE;AACvB,MAAM,QAAQ,CAAC,OAAO,CAAC,UAAU,EAAC;AAClC,KAAK;AACL,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE,QAAQ,CAAC,MAAM,GAAG,CAAC,UAAU,KAAK;AACpC,IAAI,MAAM,QAAQ,GAAG,IAAI,QAAQ,CAAC,UAAU,EAAC;AAC7C,IAAI,SAAS,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,EAAE,QAAQ,EAAC;AACxC,IAAI,OAAO,QAAQ;AACnB,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE,QAAQ,CAAC,OAAO,GAAG,CAAC,UAAU,EAAE,EAAE,KAAK,GAAG,KAAK,EAAE,GAAG,EAAE,KAAK;AAC7D,IAAI,MAAM,QAAQ,GAAG,SAAS,CAAC,GAAG,CAAC,UAAU,EAAC;AAC9C,IAAI,IAAI,CAAC,QAAQ,EAAE;AACnB,MAAM,MAAM,IAAI,aAAa,CAAC,CAAC,8BAA8B,EAAE,UAAU,CAAC,CAAC,CAAC;AAC5E,KAAK;AACL,IAAI,IAAI,CAAC,KAAK,IAAI,QAAQ,CAAC,KAAK,KAAK,QAAQ,EAAE;AAC/C,MAAM,MAAM,IAAI,aAAa,CAAC,CAAC,gCAAgC,EAAE,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,UAAU,EAAE,CAAC;AAClG,KAAK;AACL,IAAI,IAAI,QAAQ,CAAC,OAAO,EAAE;AAC1B,MAAM,QAAQ,CAAC,OAAO,CAAC,GAAG,GAAE;AAC5B,MAAM,QAAQ,CAAC,OAAO,GAAG,KAAI;AAC7B,KAAK;AACL,IAAI,QAAQ,CAAC,GAAG,GAAE;AAClB,IAAI,SAAS,CAAC,MAAM,CAAC,QAAQ,EAAC;AAC9B,IAAI,SAAS,CAAC,MAAM,CAAC,UAAU,EAAC;AAChC,IAAG;AACH;AACA;AACA,EAAE,OAAO,MAAM;AACf,IAAI,OAAO,QAAQ,CAAC,UAAS;AAC7B,IAAI,OAAO,QAAQ,CAAC,IAAG;AACvB,IAAI,OAAO,QAAQ,CAAC,IAAG;AACvB,IAAI,OAAO,QAAQ,CAAC,MAAK;AACzB,IAAI,OAAO,QAAQ,CAAC,OAAM;AAC1B,IAAI,OAAO,QAAQ,CAAC,QAAO;AAC3B,GAAG;AACH;;;;"}