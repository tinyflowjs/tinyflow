{"version":3,"file":"index.cjs.js","sources":["../index.js"],"sourcesContent":["export const withInstances = (internal, { Workflow, Tinyflow, TinyflowError }) => {\n  internal.instances = new Map()\n  const { instances, listeners } = internal\n\n  /**\n   * Gets a workflow instance by its id\n   * @method\n   * @param id {string}\n   * @returns {Workflow}\n   */\n  Tinyflow.get = id => instances.get(id)\n\n  /**\n   * Returns all non-disposed workflows of any state.\n   * @method\n   * @return {Workflow[]}\n   */\n  Tinyflow.all = () => [...instances.values()]\n\n  /**\n   * Clears all instances. By default, all engines are shut down\n   * and fire the end event.\n   * @method\n   */\n  Tinyflow.clear = () => {\n    const ids = [...instances.keys()]\n    for (const instanceId of ids) {\n      const workflow = Tinyflow.get(instanceId)\n      workflow.cancel()\n      Tinyflow.dispose(instanceId)\n    }\n  }\n\n  /**\n   * Creates a new workflow instance by given workflow definitions.\n   *\n   * @param definition {object} the workflow definitions object\n   * @returns {Workflow}\n   */\n  Tinyflow.create = (definition) => {\n    const workflow = new Workflow(definition)\n    instances.set(workflow.id, workflow)\n    return workflow\n  }\n\n  /**\n   * Fully disposes a workflow, including any event listener\n   * to it, or its current step.\n   * Once complete it will finally remove the workflow from\n   * the internal instances list.\n   * @param instanceId {string}\n   * @param force {boolean=}\n   */\n  Tinyflow.dispose = (instanceId, { force = false } = {}) => {\n    const workflow = instances.get(instanceId)\n    if (!workflow) {\n      throw new TinyflowError(`Workflow does not exist by id ${instanceId}`)\n    }\n    if (!force && workflow.state === 'active') {\n      throw new TinyflowError(`Cannot dispose active workflow \"${workflow.name}\"`, { instanceId })\n    }\n    if (workflow.current) {\n      workflow.current.off()\n      workflow.current = null\n    }\n    workflow.off()\n    listeners.delete(workflow)\n    instances.delete(instanceId)\n  }\n\n  // dispose method for complete cleanup of this extension\n  return () => {\n    delete internal.instances\n    delete Tinyflow.get\n    delete Tinyflow.all\n    delete Tinyflow.clear\n    delete Tinyflow.create\n    delete Tinyflow.dispose\n  }\n}\n"],"names":["withInstances","internal","_ref","Workflow","Tinyflow","TinyflowError","instances","Map","listeners","get","id","all","_toConsumableArray","values","clear","ids","keys","_iterator","_createForOfIteratorHelper","_step","s","n","done","instanceId","value","workflow","cancel","dispose","err","e","f","create","definition","set","_ref2","arguments","length","undefined","_ref2$force","force","concat","state","name","current","off"],"mappings":"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"}